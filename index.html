<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lyruanna</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <!-- CUSTOM TITLEBAR (Desktop Only) -->
    <div class="titlebar" id="titlebar" style="display:none;">
        <span class="titlebar-title">LYRUANNA - BMS Player</span>
        <div class="titlebar-controls">
            <button class="titlebar-btn close" id="btn-close" title="Close">
                <svg viewBox="0 0 12 12">
                    <path d="M1 1l10 10M11 1L1 11" stroke="currentColor" stroke-width="2" />
                </svg>
            </button>
        </div>
    </div>

    <div id="app">
        <!-- LOADING SCREEN -->
        <div id="screen-loading">
            <div class="loading-content">
                <img src="icon/icon.png" class="loading-icon" alt="Logo">
                <div class="loading-title">Lyruanna</div>
            </div>
            
            <div class="loading-bar-fixed-bg">
                <div class="loading-bar-fill" id="loading-bar"></div>
            </div>
            <div class="loading-status" id="loading-status">Initializing...</div>
        </div>

        <div id="exit-overlay">
            <div class="exit-message">Keep holding to exit</div>
        </div>

        <div id="exit-tooltip">Hold Escape to exit!</div>

        <!-- SELECT SCREEN -->
        <div id="screen-select">
            <div class="select-bg" id="select-bg"></div>

            <!-- Left: Song Detail Panel -->
            <div class="song-detail-panel">
                <div class="top-buttons">
                    <button class="icon-btn" id="btn-settings" title="Settings">‚öôÔ∏è</button>
                    <button class="icon-btn" id="btn-options" title="Player Options">üéÆ</button>
                    <button class="icon-btn" id="btn-scan-lib" title="Library Folders">üìÅ</button>
                    <input type="file" id="file-picker" webkitdirectory directory multiple style="display:none">
                </div>

                <div class="song-info-card" id="song-info-card">
                    <div class="banner-area" id="banner-area">
                        <span class="banner-placeholder">No song selected</span>
                    </div>
                    <div class="stagefile-area" id="stagefile-area">
                        <div class="stagefile-overlay"></div>
                        <div class="song-meta">
                            <div class="song-title-main" id="song-title-main">Select a song</div>
                            <div class="song-subtitle" id="song-subtitle"></div>
                            <div class="song-artist-genre" id="song-artist-genre"></div>

                            <div class="difficulty-display" id="difficulty-display" style="display:none;">
                                <div>
                                    <div class="diff-level" id="diff-level">--</div>
                                    <div class="diff-tier" id="diff-tier">UNKNOWN</div>
                                </div>
                                <div class="diff-stars" id="diff-stars"></div>
                            </div>

                            <div class="song-stats" id="song-stats" style="display:none;">
                                <div class="stat-row"><span class="stat-label">BPM</span><span class="stat-value"
                                        id="stat-bpm">--</span></div>
                                <div class="stat-row"><span class="stat-label">Notes</span><span class="stat-value"
                                        id="stat-notes">--</span></div>
                                <div class="stat-row"><span class="stat-label">Start NPS</span><span class="stat-value"
                                        id="stat-nps-start">--</span></div>
                                <div class="stat-row"><span class="stat-label">Avg NPS</span><span class="stat-value"
                                        id="stat-nps-avg">--</span></div>
                                <div class="stat-row"><span class="stat-label">Max NPS</span><span class="stat-value"
                                        id="stat-nps-max">--</span></div>
                                <div class="stat-row"><span class="stat-label">Rank</span><span class="stat-value"
                                        id="stat-rank">--</span></div>
                            </div>

                            <div class="song-best-score" id="song-best-score" style="background: rgba(0,0,0,0.4); border-radius: 8px; padding: 12px 16px; margin-top: 15px; border-left: 3px solid var(--accent); opacity: 0; height: 0; overflow: hidden; transition: opacity 0.2s, height 0.2s;">
                                <div style="font-size: 11px; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">BEST SCORE</div>
                                <div id="best-score-content" style="display: flex; align-items: center; gap: 12px;">
                                    <span class="lamp" id="best-lamp" style="width: 8px; height: 8px; min-width: 8px;"></span>
                                    <span id="best-grade" style="font-size: 28px; font-weight: bold; min-width: 50px;">-</span>
                                    <div style="display: flex; flex-direction: column; gap: 2px;">
                                        <span id="best-ex-score" style="font-size: 18px; font-weight: bold; color: var(--accent);">0</span>
                                        <span id="best-rate" style="font-size: 12px; color: #888;">0.00%</span>
                                    </div>
                                </div>
                                <div id="best-score-empty" style="display: none; color: #666; font-style: italic; font-size: 13px;">No best score</div>
                            </div>

                            <div class="song-markers" id="song-markers"></div>

                            <div class="start-btn-area">
                                <button class="btn-start-main" id="btn-start" disabled>START</button>
                                <div style="display:flex; gap:10px; margin-top:10px;">
                                    <button class="btn" id="btn-autoplay" style="flex:1;">AUTOPLAY</button>
                                    <button class="btn" id="btn-replay" style="flex:1;">REPLAY</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right: Song List -->
            <div class="song-list-panel">
                <div class="song-list-header">
                    <span id="song-count">0</span> Songs
                    <div class="filter-buttons">
                        <button class="filter-btn" id="btn-diff-filter" title="Difficulty Filter">DIFF: <span
                                id="diff-filter">ALL</span></button>
                        <button class="filter-btn" id="btn-km-filter" title="Key Mode Filter">MODE: <span
                                id="km-filter">ALL</span></button>
                        <button class="filter-btn" id="btn-sort" title="Sort By">SORT: <span
                                id="sort-mode">DEFAULT</span></button>
                    </div>
                </div>
                <div class="song-list" id="song-list"></div>
            </div>
        </div>

        <!-- GAME SCREEN -->
        <div id="screen-game">
            <div class="game-bg" id="game-bg"></div>
            <div class="game-bga" id="game-bga">
                <img id="bga-img" style="display:none;">
                <video id="bga-video" style="display:none;" muted></video>
            </div>
            <div class="lane-cover-top" id="lane-cover-top" style="height:0;"></div>
            <div class="lane-cover-bottom" id="lane-cover-bottom" style="height:0;"></div>
            <canvas id="game-canvas"></canvas>
            <!-- Progress Bar -->
            <div id="song-progress-bar" class="song-progress-bar">
                <div id="song-progress-fill" class="song-progress-fill"></div>
            </div>
            <div id="hud-ready">READY</div>
            <div class="hud">
                <div class="hud-bottom-left">
                    <div class="hud-score-row">
                        <div class="score-label">EX SCORE</div>
                        <div class="score-val" id="hud-score">0</div>
                    </div>
                    <div class="hud-stat-row">
                        <span class="stat-label">MAX COMBO</span>
                        <span class="stat-value small" id="hud-max-combo">0</span>
                        <span class="stat-label" style="margin-left: 10px;">RATE</span>
                        <span class="stat-value" id="hud-rate">0.00%</span>
                    </div>
                </div>


                <div id="hud-autoplay" class="hud-autoplay">AUTOPLAY</div>

                <div class="hud-gauge-group">
                    <div class="hud-gauge-container">
                        <div class="gauge-marker"></div>
                        <div class="gauge-fill" id="gauge-bar"></div>
                    </div>
                    <div class="gauge-info-under">
                        <div class="gauge-grade" id="gauge-grade">F</div>
                        <div class="gauge-val" id="gauge-val">
                            <span class="whole">20</span><span class="decimal">.0%</span>
                        </div>
                    </div>
                </div>

                <div class="hud-tally" id="hud-tally">
                    <div class="tally-row pgreat"><span class="tally-label">PGREAT</span><span class="tally-value"
                            id="tally-pg">0</span></div>
                    <div class="tally-row great"><span class="tally-label">GREAT</span><span class="tally-value"
                            id="tally-gr">0</span></div>
                    <div class="tally-row good"><span class="tally-label">GOOD</span><span class="tally-value"
                            id="tally-gd">0</span></div>
                    <div class="tally-row bad"><span class="tally-label">BAD</span><span class="tally-value"
                            id="tally-bd">0</span></div>
                    <div class="tally-row poor"><span class="tally-label">POOR</span><span class="tally-value"
                            id="tally-pr">0</span></div>
                    <hr class="tally-divider">
                    <div class="tally-row fast"><span class="tally-label">FAST</span><span class="tally-value"
                            id="tally-fast">0</span></div>
                    <div class="tally-row slow"><span class="tally-label">SLOW</span><span class="tally-value"
                            id="tally-slow">0</span></div>
                    <div class="tally-row cb"><span class="tally-label">C.BREAK</span><span class="tally-value"
                            id="tally-cb">0</span></div>
                </div>

                <div style="position:absolute; bottom:20px; width:100%; text-align:center; font-size:12px; color:#555;">
                    [ESCAPE] to Exit
                </div>

                <!-- PaceMaker Graph -->
                <div class="hud-pacemaker" id="hud-pacemaker" style="display: none;">
                    <div class="pace-score-top">
                        <div class="pace-score-row">
                            <span class="label">YOU</span>
                            <span class="val" id="pace-score-you">0</span>
                        </div>
                        <div class="pace-score-row">
                            <span class="label" id="pace-target-name">AAA</span>
                            <span class="val" id="pace-score-target">0</span>
                        </div>
                    </div>
                    <div class="pace-bars">
                        <div class="pace-bar you" id="pace-bar-you" style="height: 0%;"></div>
                        <div class="pace-bar best" id="pace-bar-best" style="height: 0%;"></div>
                        <div class="pace-bar target" id="pace-bar-target" style="height: 0%;"></div>
                    </div>
                    <div class="pace-ghost-bottom">
                        <div class="ghost-row">
                            <span class="label" id="pace-ghost-label">vs TARGET</span>
                            <span class="val" id="pace-diff-target">+0</span>
                        </div>
                        <div class="ghost-row">
                            <span class="label">vs MY BEST</span>
                            <span class="val" id="pace-diff-best">+0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- FAILED SCREEN -->
        <div id="screen-failed">
            <div class="failed-content">
                <div class="failed-text">STAGE FAILED</div>
            </div>
        </div>

        <!-- RESULTS SCREEN -->
        <div id="screen-results">
            <div class="results-header">
                <div class="results-title-area">
                    <h1 id="res-status">CLEARED</h1>
                    <div style="display: flex; align-items: center; gap: 10px; margin-top: 5px;">
                        <span id="res-lamp" class="lamp"></span>
                        <span id="res-lamp-text"
                            style="font-weight: bold; font-size: 18px; text-transform: uppercase;">--</span>
                    </div>
                    <div id="res-song-title" style="font-size: 20px; color: #888; margin-top: 10px;">Song Title</div>
                </div>
                <div class="results-rank-area">
                    <div class="rank-letter" id="res-rank">AAA</div>
                    <div class="rank-next" id="res-rank-next">NEXT RANK: +0</div>
                </div>
            </div>

            <div class="results-main">
                <div class="results-left">
                    <div class="results-card">
                        <div class="card-title">JUDGEMENT</div>
                        <div class="results-tally-grid">
                            <div class="res-tally-row res-pg"><span class="res-tally-label">PGREAT</span><span
                                    class="res-tally-val" id="res-pg">0</span></div>
                            <div class="res-tally-row res-gr"><span class="res-tally-label">GREAT</span><span
                                    class="res-tally-val" id="res-gr">0</span></div>
                            <div class="res-tally-row res-gd"><span class="res-tally-label">GOOD</span><span
                                    class="res-tally-val" id="res-gd">0</span></div>
                            <div class="res-tally-row res-bd"><span class="res-tally-label">BAD</span><span
                                    class="res-tally-val" id="res-bd">0</span></div>
                            <div class="res-tally-row res-pr"><span class="res-tally-label">POOR</span><span
                                    class="res-tally-val" id="res-pr">0</span></div>
                            <div style="border-left: 1px solid #333; margin-left: 15px; padding-left: 15px;">
                                <div class="res-tally-row"><span class="res-tally-label"
                                        style="color:#55c">FAST</span><span class="res-tally-val" id="res-fast">0</span>
                                </div>
                                <div class="res-tally-row"><span class="res-tally-label"
                                        style="color:#c55">SLOW</span><span class="res-tally-val" id="res-slow">0</span>
                                </div>
                                <div class="res-tally-row"><span class="res-tally-label" style="color:#888">MAX
                                        COMBO</span><span class="res-tally-val" id="res-max-combo">0</span></div>
                            </div>
                        </div>
                    </div>
                    <div class="results-card">
                        <div class="card-title">SCORE</div>
                        <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                            <div>
                                <div style="font-size: 14px; color: #888;">EX SCORE</div>
                                <div style="font-size: 36px; font-weight: bold; color: var(--accent);"
                                    id="res-ex-score">0</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 14px; color: #888;">PERCENTAGE</div>
                                <div style="font-size: 24px;" id="res-percent">0.00%</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="results-right">
                    <div class="results-card">
                        <div class="card-title">GROOVE GAUGE</div>
                        <div class="graph-container">
                            <canvas id="graph-gauge" class="results-graph"></canvas>
                        </div>
                    </div>
                    <div class="results-card">
                        <div class="card-title">SCORE PROGRESS</div>
                        <div class="graph-container">
                            <canvas id="graph-score" class="results-graph"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="results-footer">
                PRESS ANY KEY TO RETURN
            </div>
        </div>

        <!-- SETTINGS MODAL -->
        <div id="modal-settings" class="modal">
            <div class="modal-box">
                <div class="modal-header">Settings</div>

                <div class="modal-section">
                    <div class="modal-section-title">Display</div>
                    <div class="option-row">
                        <span class="option-label">Fullscreen</span>
                        <input type="checkbox" id="opt-fullscreen">
                    </div>
                    <div class="option-row">
                        <span class="option-label">Resolution</span>
                        <select id="opt-resolution">
                            <option value="1280x720">1280 x 720</option>
                            <option value="1600x900">1600 x 900</option>
                            <option value="1920x1080">1920 x 1080</option>
                            <option value="2560x1440">2560 x 1440</option>
                        </select>
                    </div>
                    <div class="option-row">
                        <span class="option-label">Show Judgement Tally</span>
                        <input type="checkbox" id="opt-show-tally" checked>
                    </div>
                </div>

                <div class="modal-section">
                    <div class="modal-section-title">Replay Settings</div>
                    <div class="option-row">
                        <span class="option-label">Replay Save Type</span>
                        <select id="opt-replay-type">
                            <option value="NONE">None (Do not save)</option>
                            <option value="BEST_EX">Best EX Score</option>
                            <option value="BEST_LAMP">Best Lamp</option>
                            <option value="FULL_COMBO">Full Combo / Perfect</option>
                        </select>
                    </div>
                </div>

                <div class="modal-section">
                    <div class="modal-section-title">Key Bindings</div>
                    <div class="modal-grid">
                        <div id="col-p1">
                            <h4 style="margin:0 0 10px 0; color:#888;">Player 1</h4>
                        </div>
                        <div id="col-p2">
                            <h4 style="margin:0 0 10px 0; color:#888;">Player 2</h4>
                        </div>
                    </div>
                </div>

                <div class="modal-section">
                    <div class="modal-section-title">Course Management</div>
                    <div class="option-row">
                        <button class="btn" id="btn-import-course" style="width:100%;">Import Course File
                            (.lr2crs)...</button>
                    </div>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-primary" id="btn-save-settings">Save & Close</button>
                </div>
            </div>
        </div>

        <!-- PLAYER OPTIONS MODAL (IIDX-STYLE) -->
        <div id="modal-options" class="modal modal-iidx">
            <div class="iidx-target-wheel-container">
                <div class="iidx-target-header">TARGET SCORE GRAPH</div>
                <div class="iidx-target-wheel-viewport">
                    <div class="iidx-target-wheel-strip" id="iidx-target-wheel">
                        <!-- Items populated by JS -->
                    </div>
                </div>
            </div>
            <div class="iidx-right-column">
                <div class="iidx-options-container">
                    <div class="iidx-options-header">PLAYER OPTIONS</div>

                    <!-- Keyboard Guide -->
                    <div class="iidx-keyboard-guide" id="iidx-keyboard-guide">
                        <div class="iidx-key-row">
                            <div class="iidx-key iidx-key-black" data-key="2"></div>
                            <div class="iidx-key iidx-key-black" data-key="4"></div>
                            <div class="iidx-key iidx-key-black" data-key="6"></div>
                        </div>
                        <div class="iidx-key-row">
                            <div class="iidx-key iidx-key-white" data-key="1"></div>
                            <div class="iidx-key iidx-key-white" data-key="3"></div>
                            <div class="iidx-key iidx-key-white" data-key="5"></div>
                            <div class="iidx-key iidx-key-white" data-key="7"></div>
                        </div>
                        <svg class="iidx-wiring-svg" id="iidx-wiring-svg"></svg>
                    </div>

                    <div class="iidx-options-grid">
                        <!-- COLUMN 1: KEY MODE (KEY 1) -->
                        <div class="iidx-section" id="sec-mode" data-opt="keyModeFilter">
                            <div class="iidx-section-name">MODE</div>
                            <div class="option-wheel-box" id="wheel-mode">
                                <div class="option-wheel-strip"></div>
                            </div>
                        </div>

                        <!-- COLUMN 2: STYLE (KEY 2) -->
                        <div class="iidx-section" id="sec-style" data-opt="modifier">
                            <div class="iidx-section-name">STYLE</div>
                            <div class="option-wheel-box" id="wheel-style">
                                <div class="option-wheel-strip"></div>
                            </div>
                        </div>

                        <!-- COLUMN 3: BATTLE (KEY 3) -->
                        <div class="iidx-section" id="sec-battle">
                             <div class="iidx-section-name">BATTLE</div>
                             <div class="option-wheel-box" style="opacity:0.5;">
                                 <div class="option-wheel-strip">
                                     <div class="option-wheel-item selected">OFF</div>
                                     <div class="option-wheel-item">COMING SOON</div>
                                 </div>
                             </div>
                        </div>

                        <!-- COLUMN 4: GAUGE (KEY 4) -->
                        <div class="iidx-section" id="sec-gauge" data-opt="gaugeType">
                            <div class="iidx-section-name">GAUGE</div>
                            <div class="option-wheel-box" id="wheel-gauge">
                                 <div class="option-wheel-strip"></div>
                            </div>
                        </div>

                        <!-- COLUMN 5: ASSIST/RANGE (KEY 6, 6+7) -->
                        <div class="iidx-section" id="sec-assist">
                            <div class="iidx-section-name">ASSIST / RANGE</div>
                            
                            <div style="margin-bottom: 5px;">
                                <div class="iidx-opt-subname">ASSIST [KEY 6]</div>
                                <div class="option-wheel-box" id="wheel-assist" data-opt="assistMode">
                                     <div class="option-wheel-strip"></div>
                                </div>
                            </div>

                            <div>
                                <div class="iidx-opt-subname">RANGE [KEY 6+7]</div>
                                 <div class="option-wheel-box" id="wheel-range" data-opt="rangeMode">
                                     <div class="option-wheel-strip"></div>
                                </div>
                            </div>
                        </div>

                        <!-- COLUMN 6: HI-SPEED (KEY 5/7, 5+7) -->
                        <div class="iidx-section" id="sec-hispeed">
                            <div class="iidx-section-name">HI-SPEED</div>
                            
                            <div class="iidx-hs-display" style="margin-bottom:10px;">
                                <div class="iidx-hs-val" id="opt-hispeed-val">4.0</div>
                                <div class="iidx-hs-fix" id="opt-hsfix-val">FIX: NONE</div>
                            </div>

                            <div>
                                 <div class="iidx-opt-subname">HS FIX [KEY 5+7]</div>
                                 <div class="option-wheel-box" id="wheel-hsfix" data-opt="hiSpeedFix">
                                     <div class="option-wheel-strip"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Detached Exit Button -->
                <button class="iidx-btn-large" id="btn-save-options">EXIT [START]</button>
            </div>
        </div>

        <!-- LIBRARY FOLDERS MODAL -->
        <div id="modal-folders" class="modal">
            <div class="modal-box">
                <div class="modal-header">Library Folders</div>

                <div class="modal-section">
                    <div class="modal-section-title">Song Directories</div>
                    <div class="folder-list" id="folder-list">
                        <div class="no-folders">No folders added yet</div>
                    </div>
                    <div class="folder-actions">
                        <button class="btn btn-primary" id="btn-add-folder">üìÅ Add Folder</button>
                        <button class="btn" id="btn-rescan-all">üîÑ Rescan All</button>
                    </div>
                </div>

                <div class="progress-section" id="progress-section" style="display: none;">
                    <div class="modal-section-title">Scan Progress</div>
                    <div class="progress-bar-container">
                        <div class="progress-bar-fill" id="progress-bar-fill"></div>
                    </div>
                    <div class="progress-status" id="progress-status">Ready</div>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-primary" id="btn-close-folders">Close</button>
                </div>
            </div>
        </div>

        <!-- DECIDE SCREEN -->
        <div id="screen-decide">
            <div class="decide-content">
                <div class="decide-title" id="decide-title">SONG TITLE</div>
                <div class="decide-artist" id="decide-artist">ARTIST NAME</div>
            </div>
        </div>
    </div>

    <script src="renderers/Renderer7K.js"></script>
    <script src="renderers/Renderer5K.js"></script>
    <script src="renderers/Renderer9K.js"></script>
    <script src="renderers/Renderer14K.js"></script>
    <script src="renderers/Renderer10K.js"></script>
    <script src="game.js"></script>
</body>

</html>
