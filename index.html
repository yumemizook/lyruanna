<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lyruanna</title>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <!-- CUSTOM TITLEBAR (Desktop Only) -->
    <div class="titlebar" id="titlebar" style="display:none;">
        <img src="icon/icon.png" class="titlebar-icon">
        <span class="titlebar-title">LYRUANNA - BMS Player</span>
        <div class="titlebar-controls">
            <button class="titlebar-btn close" id="btn-close" title="Close">
                <svg viewBox="0 0 12 12">
                    <path d="M1 1l10 10M11 1L1 11" stroke="currentColor" stroke-width="2" />
                </svg>
            </button>
        </div>
    </div>

    <div id="app">
        <!-- TACHI PROFILE DISPLAY -->
        <div id="profile-display">
            <div class="profile-avatar-container">
                <img id="profile-avatar"
                    src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23666'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E">
            </div>
            <div class="profile-info">
                <div class="profile-name" id="profile-name">Guest</div>
                <div class="profile-stats">
                    <span id="profile-rating-icon"></span>
                    <span id="profile-rating">OFFLINE</span>
                </div>
            </div>
        </div>

        <div id="fps-display">60 FPS</div>

        <!-- LOADING SCREEN -->
        <div id="screen-loading">
            <div class="loading-content">
                <img src="icon/icon.png" class="loading-icon" alt="Logo">
                <div class="loading-title">Lyruanna</div>
            </div>

            <div class="loading-bar-fixed-bg">
                <div class="loading-bar-fill" id="loading-bar"></div>
            </div>
            <div class="loading-status" id="loading-status">Initializing...</div>
        </div>

        <div id="exit-overlay">
            <div class="exit-message">Keep holding to exit</div>
        </div>

        <div id="exit-tooltip">Hold Escape to exit!</div>

        <!-- SELECT SCREEN -->
        <div id="screen-select">
            <div class="select-bg" id="select-bg"></div>

            <!-- Left: Song Detail Panel -->
            <div class="song-detail-panel">
                <div class="top-buttons">
                    <button class="icon-btn" id="btn-settings" title="Settings"><i class="ph ph-gear"
                            style="color:var(--accent)"></i></button>
                    <button class="icon-btn" id="btn-options" title="Player Options"><i class="ph ph-game-controller"
                            style="color:var(--accent)"></i></button>
                    <button class="icon-btn" id="btn-scan-lib" title="Library Folders"><i class="ph ph-folder"
                            style="color:var(--accent)"></i></button>
                    <input type="file" id="file-picker" webkitdirectory directory multiple style="display:none">
                </div>

                <div class="song-info-card" id="song-info-card">
                    <div class="banner-area" id="banner-area">
                        <span class="banner-placeholder">No song selected</span>
                    </div>
                    <div class="stagefile-area" id="stagefile-area">
                        <div class="stagefile-overlay"></div>
                        <div class="song-meta">
                            <div class="song-title-main" id="song-title-main">Select a song</div>
                            <div class="song-subtitle" id="song-subtitle"></div>
                            <div class="song-artist-genre" id="song-artist-genre"></div>

                            <div class="difficulty-display" id="difficulty-display" style="display:none;">
                                <div>
                                    <div class="diff-level" id="diff-level">--</div>
                                    <div class="diff-tier" id="diff-tier">UNKNOWN</div>
                                </div>
                                <div class="diff-stars" id="diff-stars"></div>
                            </div>

                            <div class="song-stats" id="song-stats" style="display:none;">
                                <div class="stat-row"><span class="stat-label">BPM</span><span class="stat-value"
                                        id="stat-bpm">--</span></div>
                                <div class="stat-row"><span class="stat-label">Notes</span><span class="stat-value"
                                        id="stat-notes">--</span></div>
                                <div class="stat-row"><span class="stat-label">Start NPS</span><span class="stat-value"
                                        id="stat-nps-start">--</span></div>
                                <div class="stat-row"><span class="stat-label">Avg NPS</span><span class="stat-value"
                                        id="stat-nps-avg">--</span></div>
                                <div class="stat-row"><span class="stat-label">Max NPS</span><span class="stat-value"
                                        id="stat-nps-max">--</span></div>
                                <div class="stat-row"><span class="stat-label">Rank</span><span class="stat-value"
                                        id="stat-rank">--</span></div>
                            </div>

                            <div class="song-best-score" id="song-best-score"
                                style="background: rgba(0,0,0,0.4); border-radius: 8px; padding: 12px 16px; margin-top: 15px; border-left: 3px solid var(--accent); opacity: 0; height: 0; overflow: hidden; transition: opacity 0.2s, height 0.2s;">
                                <div
                                    style="font-size: 11px; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">
                                    BEST SCORE</div>
                                <div id="best-score-content" style="display: flex; align-items: center; gap: 12px;">
                                    <span class="lamp" id="best-lamp"
                                        style="width: 8px; height: 8px; min-width: 8px;"></span>
                                    <span id="best-grade"
                                        style="font-size: 28px; font-weight: bold; min-width: 50px;">-</span>
                                    <div style="display: flex; flex-direction: column; gap: 2px;">
                                        <span id="best-ex-score"
                                            style="font-size: 18px; font-weight: bold; color: var(--accent);">0</span>
                                        <span id="best-rate" style="font-size: 12px; color: #888;">0.00%</span>
                                    </div>
                                </div>
                                <div id="best-score-empty"
                                    style="display: none; color: #666; font-style: italic; font-size: 13px;">No best
                                    score</div>
                            </div>

                            <div class="song-markers" id="song-markers"></div>

                            <div class="start-btn-area">
                                <button class="btn-start-main" id="btn-start" disabled>START</button>
                                <div style="display:flex; gap:10px; margin-top:10px;">
                                    <button class="btn" id="btn-autoplay" style="flex:1;">AUTOPLAY</button>
                                    <button class="btn" id="btn-replay" style="flex:1;">REPLAY</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right: Song List -->
            <div class="song-list-panel">
                <div class="song-list-header">
                    <span id="song-count">0</span> Songs
                    <div class="filter-buttons">
                        <button class="filter-btn" id="btn-diff-filter" title="Difficulty Filter">DIFF: <span
                                id="diff-filter">ALL</span></button>
                        <button class="filter-btn" id="btn-km-filter" title="Key Mode Filter">MODE: <span
                                id="km-filter">ALL</span></button>
                        <button class="filter-btn" id="btn-sort" title="Sort By">SORT: <span
                                id="sort-mode">DEFAULT</span></button>
                    </div>
                </div>
                <div class="song-list" id="song-list"></div>
            </div>
        </div>

        <!-- GAME SCREEN -->
        <div id="screen-game">
            <div class="game-bg" id="game-bg"></div>
            <div class="game-bga" id="game-bga">
                <!-- Chroma Key Filter for handling Black Transparent BGAs -->
                <svg style="width:0; height:0; position:absolute; visibility:hidden;">
                    <defs>
                        <filter id="chromakey">
                            <feColorMatrix type="matrix" values="1 0 0 0 0
                                                                 0 1 0 0 0
                                                                 0 0 1 0 0
                                                                 50 50 50 0 -1" />
                            <!-- Alpha = 50*R + 50*G + 50*B - 1. 
                                                                      Ensures (0,0,0) -> -1 (Transp). 
                                                                      Very dark colors > 0 (Opaque). -->
                        </filter>
                    </defs>
                </svg>
                <img id="bga-img"
                    style="visibility:hidden; position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover;">
                <video id="bga-video"
                    style="visibility:hidden; position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover;"
                    muted></video>
                <img id="bga-layer"
                    style="visibility:hidden; position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover; z-index:2; filter: url(#chromakey);">
            </div>
            <!-- Ghost Score Display (Centered, just value) -->
            <div id="ghost-display"
                style="position:absolute; top: 60%; left: 200px; transform: translate(-50%, -50%); text-align: center; display: none; z-index: 10; pointer-events: none;">
                <div id="ghost-val-target"
                    style="font-size: 32px; font-weight: bold; text-shadow: 0 0 4px rgba(0,0,0,0.8);">+0</div>
            </div>
            <div class="lane-cover-top" id="lane-cover-top" style="height:0;"></div>
            <div class="lane-cover-bottom" id="lane-cover-bottom" style="height:0;"></div>
            <!-- Green/White Number HUD (visible when holding START in-game) -->
            <div id="lane-cover-info" class="lane-cover-info" style="display:none;">
                <span id="hud-white-number">200</span>
                <span id="hud-green-number">300</span>
            </div>
            <canvas id="game-canvas"></canvas>
            <!-- Progress Bar -->
            <div id="song-progress-bar" class="song-progress-bar">
                <div id="song-progress-fill" class="song-progress-fill"></div>
            </div>
            <div id="hud-ready">READY</div>
            <div class="hud">
                <div class="hud-bottom-left">
                    <div class="hud-score-row">
                        <div class="score-label">EX SCORE</div>
                        <div class="score-val" id="hud-score">0</div>
                    </div>
                    <div class="hud-stat-row">
                        <span class="stat-label">MAX COMBO</span>
                        <span class="stat-value small" id="hud-max-combo">0</span>
                        <span class="stat-label" style="margin-left: 10px;">RATE</span>
                        <span class="stat-value" id="hud-rate">0.00%</span>
                    </div>
                </div>


                <div id="hud-autoplay" class="hud-autoplay">AUTOPLAY</div>

                <div class="hud-gauge-group">
                    <div class="hud-gauge-container">
                        <div class="gauge-marker"></div>
                        <div class="gauge-fill" id="gauge-bar"></div>
                    </div>
                    <div class="gauge-info-under">
                        <div class="gauge-grade" id="gauge-grade">F</div>
                        <div class="gauge-val" id="gauge-val">
                            <span class="whole">20</span><span class="decimal">.0%</span>
                        </div>
                    </div>
                </div>

                <!-- Inline Ghost Indicator (above judgement) -->
                <div id="pace-ghost-inline" style="display:none;">+0</div>

                <div class="hud-tally" id="hud-tally">
                    <div class="tally-row pgreat"><span class="tally-label">PGREAT</span><span class="tally-value"
                            id="tally-pg">0</span></div>
                    <div class="tally-row great"><span class="tally-label">GREAT</span><span class="tally-value"
                            id="tally-gr">0</span></div>
                    <div class="tally-row good"><span class="tally-label">GOOD</span><span class="tally-value"
                            id="tally-gd">0</span></div>
                    <div class="tally-row bad"><span class="tally-label">BAD</span><span class="tally-value"
                            id="tally-bd">0</span></div>
                    <div class="tally-row poor"><span class="tally-label">POOR</span><span class="tally-value"
                            id="tally-pr">0</span></div>
                    <hr class="tally-divider">
                    <div class="tally-row fast"><span class="tally-label">FAST</span><span class="tally-value"
                            id="tally-fast">0</span></div>
                    <div class="tally-row slow"><span class="tally-label">SLOW</span><span class="tally-value"
                            id="tally-slow">0</span></div>
                    <div class="tally-row cb"><span class="tally-label">C.BREAK</span><span class="tally-value"
                            id="tally-cb">0</span></div>
                </div>

                <div style="position:absolute; bottom:20px; width:100%; text-align:center; font-size:12px; color:#555;">
                    [ESCAPE] to Exit
                </div>

                <!-- PaceMaker Graph -->
                <div class="hud-pacemaker" id="hud-pacemaker" style="display: none;">
                    <div class="pace-score-top">
                        <div class="pace-score-row">
                            <span class="label">YOU</span>
                            <span class="val" id="pace-score-you">0</span>
                        </div>
                        <div class="pace-score-row">
                            <span class="label" id="pace-target-name">AAA</span>
                            <span class="val" id="pace-score-target">0</span>
                        </div>
                    </div>
                    <div class="pace-bars">
                        <div class="pace-bar you" id="pace-bar-you" style="height: 0%;"></div>
                        <div class="pace-bar best" id="pace-bar-best" style="height: 0%;"></div>
                        <div class="pace-bar target" id="pace-bar-target" style="height: 0%;"></div>
                    </div>
                    <div class="pace-ghost-bottom">
                        <div class="ghost-row">
                            <span class="label" id="pace-ghost-label">vs TARGET</span>
                            <span class="val" id="pace-diff-target">+0</span>
                        </div>
                        <div class="ghost-row">
                            <span class="label">vs MY BEST</span>
                            <span class="val" id="pace-diff-best">+0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- FAILED SCREEN -->
        <div id="screen-failed">
            <div class="failed-content">
                <div class="failed-text">STAGE FAILED</div>
            </div>
        </div>

        <!-- RESULTS SCREEN -->
        <div id="screen-results">
            <div class="results-layout">
                <!-- Top Row: Graphs & Status -->
                <div class="results-top-row">
                    <div class="results-graph-box left">
                        <div class="graph-label">GAUGE HISTORY</div>
                        <div class="canvas-wrapper">
                            <canvas id="graph-gauge" class="results-canvas"></canvas>
                            <div class="graph-overlay bottom-left" id="res-gauge-opts">Running Options</div>
                            <div class="graph-overlay bottom-right" id="res-gauge-val">100%</div>
                        </div>
                    </div>

                    <div class="results-bms-status">
                        <div class="res-mini-info" id="res-song-title">Song Title</div>
                        <div class="res-mini-info" id="res-artist">Artist</div>
                        <h1 id="res-status" class="res-status-text">CLEARED</h1>
                        <div class="res-lamp-container">
                            <span id="res-lamp" class="lamp-dot"></span>
                            <span id="res-lamp-text">FULL COMBO</span>
                        </div>
                    </div>

                    <div class="results-graph-box right">
                        <div class="graph-label">SCORE PROGRESS</div>
                        <div class="canvas-wrapper">
                            <canvas id="graph-score" class="results-canvas"></canvas>
                            <div class="graph-overlay bottom-left" id="res-score-rate">95.43%</div>
                            <div class="graph-overlay bottom-right" id="res-score-grade">AAA</div>
                        </div>
                    </div>
                </div>

                <!-- Bottom Row: Tally & Stats -->
                <div class="results-stats-row">
                    <!-- Left Column: Judgement Tally -->
                    <div class="results-col left-tally">
                        <div class="col-header">JUDGEMENT</div>
                        <div class="tally-grid">
                            <div class="tally-item pg"><span class="label">PGREAT</span><span class="value"
                                    id="res-pg">0</span></div>
                            <div class="tally-item gr"><span class="label">GREAT</span><span class="value"
                                    id="res-gr">0</span></div>
                            <div class="tally-item gd"><span class="label">GOOD</span><span class="value"
                                    id="res-gd">0</span></div>
                            <div class="tally-item bd"><span class="label">BAD</span><span class="value"
                                    id="res-bd">0</span></div>
                            <div class="tally-item pr"><span class="label">POOR</span><span class="value"
                                    id="res-pr">0</span></div>
                            <div class="tally-sep"></div>
                            <div class="tally-item fast"><span class="label">FAST</span><span class="value"
                                    id="res-fast">0</span></div>
                            <div class="tally-item slow"><span class="label">SLOW</span><span class="value"
                                    id="res-slow">0</span></div>
                            <div class="tally-sep"></div>
                            <div class="tally-item ex"><span class="label">EX SCORE</span><span class="value"
                                    id="res-ex-score">0</span></div>
                            <div class="tally-item cb"><span class="label">MAX COMBO</span><span class="value"
                                    id="res-max-combo">0</span></div>
                            <div class="tally-item cb-count"><span class="label">C.BREAK</span><span class="value"
                                    id="res-combo-breaks">0</span></div>
                        </div>
                    </div>

                    <!-- Right Column: Extended Stats -->
                    <div class="results-col right-stats">
                        <div class="col-header">STATISTICS</div>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <span class="label">MEAN ERROR</span>
                                <span class="value" id="res-mean">0.00ms</span>
                            </div>
                            <div class="stat-item">
                                <span class="label">STD DEV</span>
                                <span class="value" id="res-std-dev">0.00ms</span>
                            </div>
                            <div class="stat-sep"></div>
                            <div class="stat-item">
                                <span class="label">PG / GR Ratio</span>
                                <span class="value" id="res-ratio-pg">0:0</span>
                            </div>
                            <div class="stat-item">
                                <span class="label">GR / GD Ratio</span>
                                <span class="value" id="res-ratio-gr">0:0</span>
                            </div>
                            <div class="stat-sep"></div>
                            <div class="stat-item highlight">
                                <span class="label">TARGET DIFF</span>
                                <span class="value" id="res-target-diff">+0</span>
                            </div>
                            <div class="stat-item next-rank">
                                <span class="label">NEXT GRADE</span>
                                <span class="value" id="res-rank-next">MAX</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="results-footer-msg">
                    PRESS START or KEYS to EXIT
                </div>
            </div>
        </div>

        <!-- SETTINGS MODAL -->
        <div id="modal-settings" class="modal">
            <div class="modal-box">
                <div class="modal-header">Settings</div>

                <div class="modal-section">
                    <div class="modal-section-title">Display</div>
                    <div class="option-row">
                        <span class="option-label">Fullscreen</span>
                        <input type="checkbox" id="opt-fullscreen">
                    </div>
                    <div class="option-row">
                        <span class="option-label">Resolution</span>
                        <select id="opt-resolution">
                            <option value="1280x720">1280 x 720</option>
                            <option value="1600x900">1600 x 900</option>
                            <option value="1920x1080">1920 x 1080</option>
                            <option value="2560x1440">2560 x 1440</option>
                        </select>
                    </div>
                    <div class="option-row">
                        <span class="option-label">Show Judgement Tally</span>
                        <input type="checkbox" id="opt-show-tally" checked>
                    </div>
                    <div class="option-row">
                        <span class="option-label">Green Number Fix (Floating)</span>
                        <input type="checkbox" id="opt-green-fix">
                    </div>
                    <div class="option-row">
                        <span class="option-label">Frame Limit</span>
                        <select id="opt-frame-limit">
                            <option value="VSYNC">VSync</option>
                            <option value="120">2x refresh (120 FPS)</option>
                            <option value="240">4x refresh (240 FPS)</option>
                            <option value="480">8x refresh (480 FPS)</option>
                            <option value="960">16x refresh (960 FPS)</option>
                            <option value="UNLIMITED">Unlimited</option>
                        </select>
                    </div>
                </div>

                <div class="modal-section">
                    <div class="modal-section-title">Replay Settings</div>
                    <div class="option-row">
                        <span class="option-label">Replay Save Type</span>
                        <select id="opt-replay-type">
                            <option value="NONE">None (Do not save)</option>
                            <option value="BEST_EX">Best EX Score</option>
                            <option value="BEST_LAMP">Best Lamp</option>
                            <option value="FULL_COMBO">Full Combo / Perfect</option>
                        </select>
                    </div>
                </div>

                <div class="modal-section">
                    <div class="modal-section-title">Key Bindings</div>
                    <div class="modal-grid">
                        <div id="col-p1">
                            <h4 style="margin:0 0 10px 0; color:#888;">Player 1</h4>
                        </div>
                        <div id="col-p2">
                            <h4 style="margin:0 0 10px 0; color:#888;">Player 2</h4>
                        </div>
                    </div>
                </div>

                <div class="modal-section">
                    <div class="modal-section-title">Course Management</div>
                    <div class="option-row">
                        <button class="btn" id="btn-import-course" style="width:100%;">Import Course File
                            (.lr2crs)...</button>
                    </div>
                </div>

                <div class="modal-section">
                    <div class="modal-section-title">Internet Ranking (Tachi)</div>
                    <div class="option-row">
                        <span class="option-label">API Key</span>
                        <input type="password" id="opt-tachi-api-key" placeholder="Enter your Tachi API Key"
                            style="flex:1; background:#1a1a1a; border:1px solid #333; color:#fff; padding:8px 10px; border-radius:4px; font-family:inherit;">
                    </div>
                    <div class="option-row" style="gap:10px;">
                        <button class="btn" id="btn-tachi-get-key" style="flex:1;">Get API Key</button>
                        <button class="btn" id="btn-tachi-test" style="flex:1;">Test Connection</button>
                    </div>
                    <div class="option-row" style="gap:10px; margin-top:5px;">
                        <button class="btn" id="btn-tachi-pause" style="flex:1; font-size:11px;">Disable (+5m)</button>
                        <button class="btn" id="btn-tachi-resume" style="flex:1; font-size:11px;">Enable Now</button>
                    </div>
                    <div id="tachi-submission-status"
                        style="font-size:11px; color:#aaa; margin-top:2px; text-align:right;">Submissions enabled</div>
                    <div id="tachi-status" style="font-size:12px; color:#888; margin-top:5px;">Not connected</div>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-primary" id="btn-save-settings">Save & Close</button>
                </div>
            </div>
        </div>

        <!-- PLAYER OPTIONS MODAL (Beatoraja-style Redesign) -->
        <div id="modal-options" class="modal modal-advanced-beatoraja">
            <div class="adv-container">
                <!-- Left Column: SUB MENU (Targets) -->
                <div class="adv-sub-menu">
                    <div class="adv-sub-header">TARGET SCORE</div>
                    <div class="adv-sub-note">Select a target score for the graph</div>
                    <div class="adv-misc-section">
                        <div class="adv-misc-title">TARGET LIST</div>
                        <div class="adv-misc-hint">Click a target to select</div>
                        <div class="adv-misc-grid" id="iidx-target-list">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <div class="adv-misc-section" style="margin-top: auto;">
                        <div class="adv-misc-title">INFORMATION</div>
                        <div class="adv-box-desc" style="font-size: 10px; color: #888;">
                            • SELECT: Cycle options<br>
                            • START: Save & Exit<br>
                            • 1/3/5/7: Fast select
                        </div>
                    </div>
                </div>

                <!-- Right Column: OPTION MENU -->
                <div class="adv-option-menu">
                    <div class="adv-option-header">OPTION MENU</div>
                    <div class="adv-option-note">Configure your play environment</div>

                    <div class="adv-options-top"
                        style="display:flex; justify-content: space-between; align-items: flex-start; margin-bottom:12px;">
                        <!-- Keyboard Guide (Center) -->
                        <div class="adv-keyboard-guide" style="flex: 1;">
                            <div class="adv-key-row black">
                                <div class="adv-key black key-orange" data-key="2">2</div>
                                <div class="adv-key black key-green" data-key="4">4</div>
                                <div class="adv-key black key-green" data-key="6">6</div>
                            </div>
                            <div class="adv-key-row white">
                                <div class="adv-key white key-magenta" data-key="1">1</div>
                                <div class="adv-key white key-cyan" data-key="3">3</div>
                                <div class="adv-key white key-white" data-key="5">5</div>
                                <div class="adv-key white key-white" data-key="7">7</div>
                            </div>
                        </div>

                        <!-- DP/Extra Option box (Right) -->
                        <div class="adv-box adv-box-white" id="adv-box-extra" style="width: 180px; flex: 0 0 auto;">
                            <div class="adv-box-header">DPオプション</div>
                            <div class="adv-box-subheader">EXTRA OPTION</div>
                            <div class="adv-box-buttons vertical">
                                <button class="adv-btn active">OFF</button>
                                <button class="adv-btn">FLIP</button>
                                <button class="adv-btn">BATTLE</button>
                            </div>
                        </div>
                    </div>

                    <!-- Main Options Grid -->
                    <div class="adv-options-grid">
                        <div class="adv-box adv-box-orange" id="adv-box-style">
                            <div class="adv-box-header">譜面の配置</div>
                            <div class="adv-box-subheader">STYLE [KEY 1/2]</div>
                            <div class="adv-box-buttons vertical">
                                <!-- Populated by JS -->
                            </div>
                        </div>

                        <div class="adv-box adv-box-white" id="adv-box-battle">
                            <div class="adv-box-header">対戦オプション</div>
                            <div class="adv-box-subheader">BATTLE [KEY 3]</div>
                            <div class="adv-box-buttons vertical">
                                <!-- Populated by JS -->
                            </div>
                        </div>

                        <div class="adv-box adv-box-green" id="adv-box-gauge">
                            <div class="adv-box-header">グルーヴゲージ</div>
                            <div class="adv-box-subheader">GAUGE [KEY 4]</div>
                            <div class="adv-box-buttons vertical">
                                <!-- Populated by JS -->
                            </div>
                        </div>

                        <div class="adv-box adv-box-pink" id="adv-box-hsfix">
                            <div class="adv-box-header">スクロール固定</div>
                            <div class="adv-box-subheader">HS FIX [KEY 5]</div>
                            <div class="adv-box-buttons vertical">
                                <!-- Populated by JS -->
                            </div>
                        </div>

                        <div class="adv-box adv-box-cyan" id="adv-box-sudden-plus">
                            <div class="adv-box-header">SUDDEN+設定</div>
                            <div class="adv-box-subheader">LANE COVER [KEY 6]</div>
                            <div class="adv-box-buttons vertical">
                                <!-- Populated by JS -->
                            </div>
                        </div>

                        <div class="adv-box adv-box-blue" id="adv-box-visibility">
                            <div class="adv-box-header">表示オプション</div>
                            <div class="adv-box-subheader">VISIBILITY [KEY 7]</div>
                            <div class="adv-box-buttons vertical">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                    </div>

                    <button class="adv-btn" id="btn-save-options"
                        style="margin-top:15px; width:100%; height:40px; font-weight:bold; font-size: 14px; letter-spacing: 2px;">EXIT
                        [START]</button>
                </div>
            </div>
        </div>

        <!-- ASSIST OPTIONS MODAL -->
        <div id="modal-assist" class="modal modal-advanced-beatoraja assist-theme">
            <div class="adv-container">
                <div class="adv-sub-menu">
                    <div class="adv-sub-header">ASSIST MENU</div>
                    <div class="adv-sub-note">Options that disable score saving</div>

                    <div class="adv-misc-section" style="margin-top: auto;">
                        <div class="adv-misc-title">WARNING</div>
                        <div class="adv-box-desc" style="font-size: 10px; color: #ff8888;">
                            • Scores will NOT be saved<br>
                            • IR submission disabled
                        </div>
                    </div>
                </div>

                <div class="adv-option-menu">
                    <div class="adv-option-header">ASSIST OPTIONS</div>
                    <div class="adv-option-note">Configuration for practice and assistance</div>

                    <div class="adv-keyboard-guide">
                        <div class="adv-key-row black">
                            <div class="adv-key black key-cyan" data-key="2">2</div>
                            <div class="adv-key black key-cyan" data-key="4">4</div>
                            <div class="adv-key black key-cyan" data-key="6">6</div>
                        </div>
                        <div class="adv-key-row white">
                            <div class="adv-key white key-cyan" data-key="1">1</div>
                            <div class="adv-key white key-cyan" data-key="3">3</div>
                            <div class="adv-key white key-cyan" data-key="5">5</div>
                            <div class="adv-key white key-cyan" data-key="7">7</div>
                        </div>
                    </div>

                    <div class="adv-options-grid" id="assist-options-grid">
                        <!-- Key 1: Expand judge -->
                        <div class="adv-box adv-box-cyan" id="assist-box-expand-judge">
                            <div class="adv-box-header">判定拡大</div>
                            <div class="adv-box-subheader">EXPAND JUDGE [1]</div>
                            <div class="adv-box-buttons vertical"></div>
                        </div>
                        <!-- Key 2: Regular Speed -->
                        <div class="adv-box adv-box-cyan" id="assist-box-reg-speed">
                            <div class="adv-box-header">等速設定</div>
                            <div class="adv-box-subheader">REG SPEED [2]</div>
                            <div class="adv-box-buttons vertical"></div>
                        </div>
                        <!-- Key 3: Judge Area -->
                        <div class="adv-box adv-box-cyan" id="assist-box-judge-area">
                            <div class="adv-box-header">判定エリア</div>
                            <div class="adv-box-subheader">JUDGE AREA [3]</div>
                            <div class="adv-box-buttons vertical"></div>
                        </div>
                        <!-- Key 4: Legacy Note -->
                        <div class="adv-box adv-box-cyan" id="assist-box-legacy">
                            <div class="adv-box-header">レガシーノート</div>
                            <div class="adv-box-subheader">LEGACY NOTE [4]</div>
                            <div class="adv-box-buttons vertical"></div>
                        </div>
                        <!-- Key 5: Auto-Scratch -->
                        <div class="adv-box adv-box-cyan" id="assist-box-auto-scratch">
                            <div class="adv-box-header">オートスクラッチ</div>
                            <div class="adv-box-subheader">AUTO SCRATCH [5]</div>
                            <div class="adv-box-buttons vertical"></div>
                        </div>
                        <!-- Key 6: BPM Guide -->
                        <div class="adv-box adv-box-cyan" id="assist-box-bpm-guide">
                            <div class="adv-box-header">BPMガイド</div>
                            <div class="adv-box-subheader">BPM GUIDE [6]</div>
                            <div class="adv-box-buttons vertical"></div>
                        </div>
                        <!-- Key 7: No Mines -->
                        <div class="adv-box adv-box-cyan" id="assist-box-no-mines">
                            <div class="adv-box-header">地雷削除</div>
                            <div class="adv-box-subheader">NO MINES [7]</div>
                            <div class="adv-box-buttons vertical"></div>
                        </div>
                    </div>

                    <button class="adv-btn" id="btn-save-assist"
                        style="margin-top:15px; width:100%; height:40px; font-weight:bold; font-size: 14px; letter-spacing: 2px;">CLOSE
                        [SELECT]</button>
                </div>
            </div>
        </div>


        <!-- ADVANCED OPTIONS MODAL (HOLD Digit3) - Beatoraja-style -->
        <div id="modal-advanced" class="modal modal-advanced-beatoraja" style="display:none;">
            <div class="adv-container">
                <!-- Left Column: SUB MENU -->
                <div class="adv-sub-menu">
                    <div class="adv-sub-header">SUB MENU</div>
                    <div class="adv-sub-note">鍵盤以外での設定が可能な項目です</div>

                    <!-- MISC OPTION -->
                    <div class="adv-misc-section">
                        <div class="adv-misc-title">MISC OPTION</div>
                        <div class="adv-misc-hint">項目をクリックで設定を変更</div>
                        <div class="adv-misc-grid">
                            <div class="adv-misc-item" id="adv-gas-limit">
                                <span class="adv-misc-label">LowerLimit of GAS</span>
                                <span class="adv-misc-value" id="adv-gas-limit-val">ASSIST EASY</span>
                            </div>
                            <div class="adv-misc-item" id="adv-lane-cover">
                                <span class="adv-misc-label">LANE COVER</span>
                                <span class="adv-misc-value" id="adv-lane-cover-val">ON</span>
                            </div>
                            <div class="adv-misc-item" id="adv-lift-cover">
                                <span class="adv-misc-label">LIFT COVER</span>
                                <span class="adv-misc-value" id="adv-lift-cover-val">OFF</span>
                            </div>
                            <div class="adv-misc-item" id="adv-hidden">
                                <span class="adv-misc-label">HIDDEN</span>
                                <span class="adv-misc-value" id="adv-hidden-val">OFF</span>
                            </div>
                        </div>
                    </div>

                    <!-- SOUND OPTION -->
                    <div class="adv-sound-section">
                        <div class="adv-sound-title">SOUND OPTION</div>
                        <div class="adv-sound-hint">スライダーで設定を変更</div>
                        <div class="adv-slider-row">
                            <span class="adv-slider-label">MASTER</span>
                            <input type="range" class="adv-slider" id="adv-master-vol" min="0" max="100" value="50">
                            <span class="adv-slider-val" id="adv-master-vol-val">50</span>
                        </div>
                        <div class="adv-slider-row">
                            <span class="adv-slider-label">KEY SOUND</span>
                            <input type="range" class="adv-slider" id="adv-key-vol" min="0" max="100" value="50">
                            <span class="adv-slider-val" id="adv-key-vol-val">50</span>
                        </div>
                        <div class="adv-slider-row">
                            <span class="adv-slider-label">BGY SOUND</span>
                            <input type="range" class="adv-slider" id="adv-bgy-vol" min="0" max="100" value="50">
                            <span class="adv-slider-val" id="adv-bgy-vol-val">50</span>
                        </div>
                    </div>

                    <!-- IR RIVALS -->
                    <div class="adv-rivals-section">
                        <div class="adv-misc-title">IR RIVALS</div>
                        <div class="adv-misc-hint">Enter Tachi usernames or IDs for rival tracking</div>
                        <div class="adv-rival-inputs">
                            <div class="adv-rival-row">
                                <span class="adv-rival-label">RIVAL 1</span>
                                <input type="text" class="adv-rival-input" id="adv-rival-1"
                                    placeholder="username or ID">
                            </div>
                            <div class="adv-rival-row">
                                <span class="adv-rival-label">RIVAL 2</span>
                                <input type="text" class="adv-rival-input" id="adv-rival-2"
                                    placeholder="username or ID">
                            </div>
                            <div class="adv-rival-row">
                                <span class="adv-rival-label">RIVAL 3</span>
                                <input type="text" class="adv-rival-input" id="adv-rival-3"
                                    placeholder="username or ID">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column: OPTION MENU -->
                <div class="adv-option-menu">
                    <div class="adv-option-header">OPTION MENU</div>
                    <div class="adv-option-note">白鍵盤と黒鍵盤でゲームオプションを設定できます</div>

                    <!-- New Top Row: GAS & Display Time -->
                    <div class="adv-options-top" style="display:flex; gap:12px; overflow-x:auto; margin-bottom:12px;">
                        <div class="adv-box adv-box-orange" id="adv-box-gas">
                            <div class="adv-box-header">ゲージオートシフト</div>
                            <div class="adv-box-subheader">GAUGE AUTO SHIFT</div>
                            <div class="adv-box-desc">GASを使用しません<br>指定ゲージが選択されます</div>
                            <div class="adv-box-buttons vertical">
                                <button class="adv-btn" data-val="OFF">OFF</button>
                                <button class="adv-btn" data-val="CONTINUE">CONTINUE</button>
                                <button class="adv-btn" data-val="HARD_TO_GROOVE">HARD TO GROOVE</button>
                                <button class="adv-btn" data-val="BEST_CLEAR">BEST CLEAR</button>
                                <button class="adv-btn" data-val="SELECT_TO_UNDER">SELECT TO UNDER</button>
                            </div>
                        </div>

                        <div class="adv-box adv-box-green" id="adv-box-display-time">
                            <div class="adv-box-header">ノーツ表示時間・緑数字</div>
                            <div class="adv-box-subheader">NOTES DISPLAY TIME</div>
                            <div class="adv-box-desc">DURATIONはmsでの表示時間を表記</div>
                            <div class="adv-box-values">
                                <div class="adv-val-row">
                                    <span class="adv-val-label">DURATION</span>
                                    <span class="adv-val-number" id="adv-duration-val">500</span>
                                </div>
                                <div class="adv-val-row highlight">
                                    <span class="adv-val-label">NOTES DISPLAY TIME</span>
                                    <span class="adv-val-number green" id="adv-green-val">300</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Keyboard Guide (Updated Colors) -->
                    <div class="adv-keyboard-guide">
                        <div class="adv-key-row black">
                            <div class="adv-key black key-orange" data-key="2">2</div>
                            <div class="adv-key black key-green" data-key="4">4</div>
                            <div class="adv-key black key-green" data-key="6">6</div>
                        </div>
                        <div class="adv-key-row white">
                            <div class="adv-key white key-magenta" data-key="1">1</div>
                            <div class="adv-key white key-cyan" data-key="3">3</div>
                            <div class="adv-key white key-white" data-key="5">5</div>
                            <div class="adv-key white key-white" data-key="7">7</div>
                        </div>
                    </div>

                    <!-- Main Options Grid -->
                    <!-- Main Options Grid (Bottom) -->
                    <div class="adv-options-grid">
                        <div class="adv-box adv-box-pink" id="adv-box-bga">
                            <div class="adv-box-header">BGA表示切り替え</div>
                            <div class="adv-box-subheader">BACK GROUND ANIMATION</div>
                            <div class="adv-box-buttons vertical">
                                <button class="adv-btn" data-val="ON">ON</button>
                                <button class="adv-btn" data-val="AUTO">AUTO</button>
                                <button class="adv-btn" data-val="OFF">OFF</button>
                            </div>
                        </div>


                        <div class="adv-box adv-box-cyan" id="adv-box-auto-judge">
                            <div class="adv-box-header">判定自動調節</div>
                            <div class="adv-box-subheader">AUTO ADJUST</div>
                            <div class="adv-box-desc">判定を自動調節します</div>
                            <div class="adv-box-buttons vertical">
                                <button class="adv-btn" data-val="OFF">OFF</button>
                                <button class="adv-btn" data-val="ON">ON</button>
                            </div>
                        </div>

                        <div class="adv-box adv-box-white" id="adv-box-timing">
                            <div class="adv-box-header">判定タイミング調整</div>
                            <div class="adv-box-subheader">JUDGE TIMING</div>
                            <div class="adv-box-desc">FASTが多い場合は-方向へ<br>SLOWが多い場合は+方向へ調節</div>
                            <div class="adv-timing-row">
                                <button class="adv-btn" id="adv-timing-label">JUDGE TIMING</button>
                                <span class="adv-timing-val" id="adv-timing-val">+0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- LIBRARY FOLDERS MODAL -->
        <div id="modal-folders" class="modal">
            <div class="modal-box">
                <div class="modal-header">Library Folders</div>

                <div class="modal-section">
                    <div class="modal-section-title">Song Directories</div>
                    <div class="folder-list" id="folder-list">
                        <div class="no-folders">No folders added yet</div>
                    </div>
                    <div class="folder-actions">
                        <button class="btn btn-primary" id="btn-add-folder">📁 Add Folder</button>
                        <button class="btn" id="btn-rescan-all">🔄 Rescan All</button>
                    </div>
                </div>

                <div class="progress-section" id="progress-section" style="display: none;">
                    <div class="modal-section-title">Scan Progress</div>
                    <div class="progress-bar-container">
                        <div class="progress-bar-fill" id="progress-bar-fill"></div>
                    </div>
                    <div class="progress-status" id="progress-status">Ready</div>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-primary" id="btn-close-folders">Close</button>
                </div>
            </div>
        </div>

        <!-- PLAYER DETAILS MODAL -->
        <div id="modal-player-details" class="modal">
            <div class="modal-box large-modal">
                <div class="player-details-header">
                    <div class="pd-header-banner" id="pd-header-banner"></div>
                    <div class="pd-header-left">
                        <div class="pd-avatar-container">
                            <img id="pd-avatar" src="">
                        </div>
                        <div class="pd-user-info">
                            <div class="pd-username" id="pd-username">--</div>
                            <div class="pd-rating-row">
                                <span id="pd-rating-icon"></span>
                                <span class="pd-rating-val" id="pd-rating-val">--</span>
                            </div>
                            <div class="pd-bio" id="pd-bio"></div>
                            <div class="pd-socials" id="pd-socials"></div>
                        </div>
                        <div id="pd-pause-container"
                            style="display:none; margin-left: 15px; background: rgba(255,100,0,0.1); border: 1px solid rgba(255,100,0,0.3); padding: 4px 10px; border-radius: 4px;">
                            <div style="font-size: 10px; color: #f82; font-weight: bold; letter-spacing: 0.5px;">
                                SUBMISSIONS PAUSED</div>
                            <div id="pd-pause-timer"
                                style="font-size: 14px; font-weight: 900; color: #fff; font-family: monospace;">00:00
                            </div>
                        </div>
                    </div>
                    <div class="pd-header-right">
                        <div class="pd-rank-label">CLASS RANK</div>
                        <div class="pd-rank-val" id="pd-rank-val">#--</div>
                        <div class="pd-rank-total" id="pd-rank-total">/ --</div>
                    </div>
                </div>

                <div class="player-details-body">
                    <div class="pd-tabs">
                        <button class="pd-tab active" id="pd-tab-recent">RECENT</button>
                        <button class="pd-tab" id="pd-tab-best">BEST</button>
                        <label class="pd-filter">
                            <input type="checkbox" id="pd-filter-failed">
                            <span>Hide Failed</span>
                        </label>
                    </div>
                    <div class="pd-scores-container">
                        <table class="pd-scores-table">
                            <thead>
                                <tr>
                                    <th style="width: 40px;"></th> <!-- Lamp -->
                                    <th style="text-align:left;">TITLE</th>
                                    <th>SCORE</th>
                                    <th>GRADE</th>
                                    <th>RATING</th>
                                    <th style="text-align:right;">TIME</th>
                                </tr>
                            </thead>
                            <tbody id="pd-scores-list">
                                <!-- Populated via JS -->
                            </tbody>
                        </table>
                        <div id="pd-loading" style="display:none; text-align:center; padding:20px; color:#888;">
                            Loading...</div>
                        <div id="pd-error" style="display:none; text-align:center; padding:20px; color:#f55;"></div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button class="btn" id="btn-close-player-details">Close</button>
                </div>
            </div>
        </div>

        <!-- PROFILE CUSTOMIZE MODAL -->
        <div id="modal-profile-customize" class="modal">
            <div class="modal-box customize-modal">
                <div class="modal-header">
                    <h2>Customize Profile</h2>
                    <button class="modal-close" id="btn-close-customize">&times;</button>
                </div>

                <div class="customize-body">
                    <!-- Avatar Section -->
                    <div class="customize-section">
                        <div class="customize-label">Avatar</div>
                        <div class="customize-preview avatar-preview">
                            <img id="customize-avatar-img" src="" alt="Avatar">
                            <div class="customize-placeholder" id="avatar-placeholder">
                                <i class="ph-bold ph-user"></i>
                                <span>No Avatar</span>
                            </div>
                        </div>
                        <div class="customize-actions">
                            <button class="btn btn-primary" id="btn-upload-avatar">
                                <i class="ph-bold ph-upload-simple"></i> Upload
                            </button>
                            <button class="btn btn-danger" id="btn-delete-avatar">
                                <i class="ph-bold ph-trash"></i> Remove
                            </button>
                        </div>
                        <input type="file" id="input-avatar" accept="image/jpeg,image/png,image/gif" hidden>
                    </div>

                    <!-- Banner Section -->
                    <div class="customize-section">
                        <div class="customize-label">Banner</div>
                        <div class="customize-preview banner-preview">
                            <img id="customize-banner-img" src="" alt="Banner">
                            <div class="customize-placeholder" id="banner-placeholder">
                                <i class="ph-bold ph-image"></i>
                                <span>No Banner</span>
                            </div>
                        </div>
                        <div class="customize-actions">
                            <button class="btn btn-primary" id="btn-upload-banner">
                                <i class="ph-bold ph-upload-simple"></i> Upload
                            </button>
                            <button class="btn btn-danger" id="btn-delete-banner">
                                <i class="ph-bold ph-trash"></i> Remove
                            </button>
                        </div>
                        <input type="file" id="input-banner" accept="image/jpeg,image/png,image/gif" hidden>
                    </div>
                </div>

                <div class="customize-status" id="customize-status"></div>
            </div>
        </div>

        <!-- LEADERBOARD MODAL -->
        <div id="modal-leaderboard" class="modal">
            <div class="modal-box leaderboard-modal">
                <div class="modal-header">
                    <h2 id="lb-title">Sieglinde Leaderboard</h2>
                    <button class="modal-close" id="btn-close-leaderboard">&times;</button>
                </div>
                <div class="leaderboard-body" id="lb-list">
                    <div class="lb-loading">Loading...</div>
                </div>
            </div>
        </div>

        <!-- DECIDE SCREEN -->
        <div id="screen-decide">
            <div class="decide-content">
                <div class="decide-title" id="decide-title">SONG TITLE</div>
                <div class="decide-artist" id="decide-artist">ARTIST NAME</div>
            </div>
        </div>
    </div>

    <script src="PerformanceUtils.js"></script>
    <script src="renderers/Renderer7K.js"></script>
    <script src="renderers/Renderer5K.js"></script>
    <script src="renderers/Renderer9K.js"></script>
    <script src="renderers/Renderer14K.js"></script>
    <script src="renderers/Renderer10K.js"></script>
    <script src="tachi.js"></script>
    <script src="game.js"></script>
</body>

</html>